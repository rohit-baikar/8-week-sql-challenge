-- 1. What is the total amount each customer spent at the restaurant?
SELECT
    s.customer_id,
    SUM(m.price) AS total_sales
FROM dannys_diner.sales s
INNER JOIN dannys_diner.menu m
    ON s.product_id = m.product_id
GROUP BY s.customer_id
ORDER BY s.customer_id;

-- 2. How many days has each customer visited the restaurant?
SELECT
    customer_id,
    COUNT(DISTINCT order_date) AS visited_count
FROM dannys_diner.sales
GROUP BY customer_id
ORDER BY customer_id;

-- 3. What was the first item from the menu purchased by each customer?
SELECT
    customer_id,
    product_name
FROM (
    SELECT
        s.customer_id,
        s.order_date,
        m.product_name,
        DENSE_RANK() OVER (
            PARTITION BY s.customer_id
            ORDER BY s.order_date
        ) AS rn
    FROM dannys_diner.sales s
    INNER JOIN dannys_diner.menu m
        ON s.product_id = m.product_id
) x
WHERE rn = 1;
    
-- 4. What is the most purchased item on the menu and how many times was it purchased by all customers?
WITH item_counts AS (
    SELECT
        m.product_name,
        COUNT(*) AS total_purchases
    FROM dannys_diner.sales s
    JOIN dannys_diner.menu m
        ON s.product_id = m.product_id
    GROUP BY m.product_name
)
SELECT
    product_name,
    total_purchases
FROM item_counts
WHERE total_purchases = (
    SELECT MAX(total_purchases)
    FROM item_counts
);

-- 5. Which item was the most popular for each customer?
WITH order_count AS (
    SELECT
        s.customer_id,
        m.product_name,
        COUNT(s.order_date) AS orders,
        RANK() OVER (
            PARTITION BY s.customer_id
            ORDER BY COUNT(s.order_date) DESC
        ) AS ranking
    FROM dannys_diner.sales s
    JOIN dannys_diner.menu m
        ON s.product_id = m.product_id
    GROUP BY s.customer_id, m.product_name
)
SELECT *
FROM order_count
WHERE ranking = 1;

-- 6. Which item was purchased first by the customer after they became a member?
WITH cte AS (
    SELECT
        s.customer_id,
        s.order_date,
        s.product_id,
        j.product_name,
        a.join_date,
        RANK() OVER (
            PARTITION BY s.customer_id
            ORDER BY s.order_date ASC
        ) AS ranking
    FROM sales s
    LEFT JOIN members m
        ON s.customer_id = m.customer_id
    JOIN menu j
        ON s.product_id = j.product_id
    JOIN members a
        ON s.customer_id = a.customer_id
    WHERE s.order_date > a.join_date
)
SELECT *
FROM cte
WHERE ranking = 1;


================ for Q-6 simple way====================
-- 6. Simple way
SELECT
    customer_id,
    product_name
FROM (
    SELECT
        s.customer_id,
        m.product_name,
        s.order_date,
        RANK() OVER (
            PARTITION BY s.customer_id
            ORDER BY s.order_date
        ) AS ranking
    FROM dannys_diner.sales s
    JOIN dannys_diner.members mb
        ON s.customer_id = mb.customer_id
    JOIN dannys_diner.menu m
        ON s.product_id = m.product_id
    WHERE s.order_date > mb.join_date
) t
WHERE ranking = 1;

-- 7. Which item was purchased just before the customer became a member?
SELECT
    customer_id,
    order_date,
    product_name
FROM (
    SELECT
        s.customer_id,
        m.product_name,
        s.order_date,
        RANK() OVER (
            PARTITION BY s.customer_id
            ORDER BY s.order_date DESC
        ) AS ranking
    FROM dannys_diner.sales s
    JOIN dannys_diner.members mb
        ON s.customer_id = mb.customer_id
    JOIN dannys_diner.menu m
        ON s.product_id = m.product_id
    WHERE s.order_date < mb.join_date
) t
WHERE ranking = 1;

-- 8. What is the total items and amount spent for each member before they became a member?
SELECT
    s.customer_id,
    COUNT(s.order_date) AS total_items,
    SUM(m.price) AS total_spent
FROM dannys_diner.sales s
JOIN dannys_diner.members mb
    ON s.customer_id = mb.customer_id
JOIN dannys_diner.menu m
    ON s.product_id = m.product_id
WHERE s.order_date < mb.join_date
GROUP BY s.customer_id
ORDER BY s.customer_id;

-- 9. Points calculation
SELECT
    *,
    CASE
        WHEN product_name = 'sushi' THEN price * 10 * 2
        ELSE price * 10
    END AS points
FROM menu; 
SELECT
    customer_id,
    SUM(points) AS total_points
FROM (
    SELECT
        s.customer_id,
        m.product_name,
        CASE
            WHEN m.product_name = 'sushi' THEN m.price * 10 * 2
            ELSE m.price * 10
        END AS points
    FROM sales s
    JOIN menu m
        ON s.product_id = m.product_id
) t
GROUP BY customer_id
ORDER BY customer_id;

-- 10. Points in first week after joining (including join date)
SELECT
    s.customer_id,
    SUM(
        CASE
            WHEN s.order_date BETWEEN mem.join_date
                 AND mem.join_date + INTERVAL '6 days'
                THEN m.price * 10 * 2
            WHEN m.product_name = 'sushi'
                THEN m.price * 10 * 2
            ELSE m.price * 10
        END
    ) AS total_points
FROM dannys_diner.sales s
JOIN dannys_diner.menu m
    ON s.product_id = m.product_id
JOIN dannys_diner.members mem
    ON s.customer_id = mem.customer_id
WHERE s.order_date <= DATE '2021-01-31'
GROUP BY s.customer_id
ORDER BY s.customer_id;

